name: Add User from Form

on:
  # Triggered by Formspree webhook
  repository_dispatch:
    types: [new-user]

  # Or manually add a user
  workflow_dispatch:
    inputs:
      name:
        description: "User name"
        required: true
      email:
        description: "User email"
        required: true
      timezone:
        description: "Timezone (e.g., America/New_York)"
        required: true
      exchanges:
        description: "Exchanges comma-separated (e.g., NYSE,NASDAQ)"
        required: true
        default: "NYSE,NASDAQ"

jobs:
  add-user:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Add user to users.json
        run: |
          # Get user data from webhook or manual input
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            NAME="${{ github.event.client_payload.name }}"
            EMAIL="${{ github.event.client_payload.email }}"
            TIMEZONE="${{ github.event.client_payload.timezone }}"
            EXCHANGES="${{ github.event.client_payload.exchanges }}"
          else
            NAME="${{ github.event.inputs.name }}"
            EMAIL="${{ github.event.inputs.email }}"
            TIMEZONE="${{ github.event.inputs.timezone }}"
            EXCHANGES="${{ github.event.inputs.exchanges }}"
          fi

          echo "Adding user: $NAME ($EMAIL)"

          # Convert exchanges string to JSON array
          EXCHANGES_JSON=$(echo "$EXCHANGES" | tr ',' '\n' | jq -R . | jq -s .)

          # Create new user object
          NEW_USER=$(jq -n \
            --arg name "$NAME" \
            --arg email "$EMAIL" \
            --arg timezone "$TIMEZONE" \
            --argjson exchanges "$EXCHANGES_JSON" \
            '{name: $name, email: $email, timezone: $timezone, exchanges: $exchanges}')

          # Check if user already exists
          if jq -e --arg email "$EMAIL" '.[] | select(.email == $email)' users.json > /dev/null 2>&1; then
            echo "User $EMAIL already exists, skipping..."
            exit 0
          fi

          # Add user to users.json
          jq --argjson user "$NEW_USER" '. += [$user]' users.json > users.tmp.json
          mv users.tmp.json users.json

          echo "User added successfully!"
          cat users.json

      - name: Commit and push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add users.json
          git diff --staged --quiet || git commit -m "Add user: ${{ github.event.client_payload.email || github.event.inputs.email }}"
          git push

