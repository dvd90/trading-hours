name: Add User from Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  add-user:
    # Only run if issue has "new-user" label or title starts with [NEW USER]
    if: contains(github.event.issue.labels.*.name, 'new-user') || startsWith(github.event.issue.title, '[NEW USER]')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse issue and add user
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "Parsing issue #$ISSUE_NUMBER..."

          # Parse the issue body for user details
          # Expected format:
          # Name: John Doe
          # Email: john@example.com
          # Timezone: America/New_York
          # Exchanges: NYSE, NASDAQ

          NAME=$(echo "$ISSUE_BODY" | grep -i "^name:" | cut -d':' -f2- | xargs)
          EMAIL=$(echo "$ISSUE_BODY" | grep -i "^email:" | cut -d':' -f2- | xargs)
          TIMEZONE=$(echo "$ISSUE_BODY" | grep -i "^timezone:" | cut -d':' -f2- | xargs)
          EXCHANGES=$(echo "$ISSUE_BODY" | grep -i "^exchanges:" | cut -d':' -f2- | xargs)

          echo "Name: $NAME"
          echo "Email: $EMAIL"
          echo "Timezone: $TIMEZONE"
          echo "Exchanges: $EXCHANGES"

          # Validate required fields
          if [ -z "$NAME" ] || [ -z "$EMAIL" ] || [ -z "$TIMEZONE" ]; then
            echo "‚ùå Missing required fields!"
            exit 1
          fi

          # Default exchanges if not provided
          if [ -z "$EXCHANGES" ]; then
            EXCHANGES="NYSE,NASDAQ"
          fi

          # Check if user already exists
          if jq -e --arg email "$EMAIL" '.[] | select(.email == $email)' users.json > /dev/null 2>&1; then
            echo "‚ö†Ô∏è User $EMAIL already exists, skipping..."
            echo "SKIPPED=true" >> $GITHUB_ENV
            exit 0
          fi

          # Convert exchanges to JSON array
          EXCHANGES_JSON=$(echo "$EXCHANGES" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R . | jq -s .)

          # Create new user object
          NEW_USER=$(jq -n \
            --arg name "$NAME" \
            --arg email "$EMAIL" \
            --arg timezone "$TIMEZONE" \
            --argjson exchanges "$EXCHANGES_JSON" \
            '{name: $name, email: $email, timezone: $timezone, exchanges: $exchanges}')

          echo "Adding user: $NEW_USER"

          # Add user to users.json
          jq --argjson user "$NEW_USER" '. += [$user]' users.json > users.tmp.json
          mv users.tmp.json users.json

          echo "‚úÖ User added successfully!"
          echo "USER_EMAIL=$EMAIL" >> $GITHUB_ENV
          echo "USER_NAME=$NAME" >> $GITHUB_ENV

      - name: Commit and push
        if: env.SKIPPED != 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Add user: ${{ env.USER_NAME }} (${{ env.USER_EMAIL }})"
          file_pattern: users.json

      - name: Close issue with success comment
        if: env.SKIPPED != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: '‚úÖ **User added successfully!**\n\nWelcome aboard! You\'ll start receiving daily market alerts soon. üöÄ'
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              state: 'closed'
            });

      - name: Comment if user exists
        if: env.SKIPPED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: '‚ö†Ô∏è **User already exists!**\n\nThis email is already subscribed to alerts.'
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              state: 'closed'
            });
